---
title: "CapstoneProject"
author: "Hans M. Rupp"
date: "26 5 2022"
output: pdf_document
---

```{r}
library(tidyverse)
library(caret)
library(gridExtra)
```


TODO: Replace later with code from project site
```{r}
load(file="data/edx")
load(file="data/validation")
load(file="data/movies")
```
Overview
```{r}
str(edx)

```
```{r echo=FALSE}
edx_rows <- nrow(edx)
edx_cols <- ncol(edx)
val_rows <- nrow(validation)
val_cols <- ncol(validation)
```

The edx dataset contains `r edx_rows` observations (rows) with `r edx_cols` features (columns). It will be used for training the model.
The validation dataset contains `r val_rows` observations (rows) with `r val_cols` features (columns). It will be used for validating the model

Checking for missing values
```{r}
nas <- function(x) { any(is.na(x)) }
edx %>% summarise_all(nas)
validation %>% summarise_all(nas)
```
There are no columns with NAs in the edx or the validation data. So no clean-up is necessary

Overall distribution of the ratings

```{r}
edx %>% ggplot(aes(x=rating)) + geom_histogram(binwidth = 0.5) + scale_x_continuous(breaks = seq(min(edx$rating), max(edx$rating), by = 0.5))

```

The different genres are
```{r}
dist_genres <- edx %>% distinct(genres)
dg <- as.vector(str_split(dist_genres$genres, "\\|", simplify = T))
unique(dg[dg != ""])
```


Distribution of ratings for  different genres

```{r}
hist_drama <- edx %>% filter(str_detect(genres, "Drama")) %>% ggplot(aes(x=rating)) + geom_histogram(binwidth = 0.5) + scale_x_continuous(breaks = seq(0.5, 5, by = 1)) + labs(title="Drama")

hist_comedy <- edx %>% filter(str_detect(genres, "Comedy"))  %>% ggplot(aes(x=rating)) + geom_histogram(binwidth = 0.5) + scale_x_continuous(breaks = seq(0.5, 5, by = 1)) + labs(title="Comedy")

hist_thriller <- edx %>% filter(str_detect(genres, "Thriller"))  %>% ggplot(aes(x=rating)) + geom_histogram(binwidth = 0.5) + scale_x_continuous(breaks = seq(0.5, 5, by = 1)) + labs(title="Thriller")

hist_romance <- edx %>% filter(str_detect(genres, "Romance"))  %>% ggplot(aes(x=rating)) + geom_histogram(binwidth = 0.5) + scale_x_continuous(breaks = seq(0.5, 5, by = 1)) + labs(title="Romance")

grid.arrange(hist_drama, hist_comedy, hist_thriller,hist_romance, ncol = 2)
```

Different users have widely different numbers of ratings

```{r}
edx %>% count(userId) %>% ggplot(aes(x=n)) + geom_histogram() + scale_x_log10() + xlab("Ratings per user (log)")
```

Some movies are rated more often

```{r}
edx %>% group_by(movieId) %>% summarise(n=n()) %>% ggplot(aes(x=n)) + geom_histogram() + scale_x_log10() + xlab("Ratings per movie (log)")

```

##Release year has some influence on average rating
Extract the release date from the title

```{r}
release_year_edx <- as.numeric(str_sub(edx$title, start=-5, end=-2))
edx <- edx %>% mutate(year=release_year_edx)
validation <- validation %>% mutate(year=as.numeric(str_sub(title, start=-5, end=-2)))
```
Plot of the average rating for each release year

```{r}
edx %>% group_by(year) %>% summarise(avg_rating = mean(rating)) %>% ggplot(aes(x=year, y=avg_rating)) + geom_point() + geom_smooth()

```



# Matrix Factorization
We will use Matrix Factorization to build a model to predict movie ratings


## RMSE
The Root Mean Square Error will be used as the Loss function
```{r}

RMSE <- function(true_ratings, predicted_ratings){
  sqrt(mean((true_ratings - predicted_ratings)^2))
}
```

## Naive model: simply using the mean ratings

```{r}
mu_rating <- mean(edx$rating)
rmse_mean <- RMSE(edx$rating, mu_rating)
rmse_mean

```
This gives a RMSE of `r rmse_mean`

We build a table of the RMSEs for the different models:

```{r}
models <- tibble(model="Mean", rmse=rmse_mean)
```



